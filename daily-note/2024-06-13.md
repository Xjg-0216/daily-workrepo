#### 工作内容


vtl forward 优化部分
https://chatgpt.com/share/9df8e93e-a292-4254-8c09-5a05135b389b


```python
def forward(self, x):

	if self.work_with_tokens:
	
		x = x.permute(0, 2, 1)
		
		N, D, _ = x.shape[:]
	
	else:
	
		N, D, H, W = x.shape[:]
	
	if self.normalize_input:
	
		x = F.normalize(x, p=2, dim=1) # Across descriptor dim
	
	x_flatten = x.view(N, D, -1)
	
	soft_assign = self.conv(x).view(N, self.clusters_num, -1)
	
	soft_assign = F.softmax(soft_assign, dim=1)
	
	# Compute the residuals in a batch operation compatible with ONNX
	
	centroids_expand = self.centroids.unsqueeze(0).unsqueeze(-1)
	
	x_flatten_expand = x_flatten.unsqueeze(1)
	
	residual = x_flatten_expand - centroids_expand
	
	residual *= soft_assign.unsqueeze(2)
	
	# Compute vlad in a batch operation
	
	vlad = residual.sum(dim=-1)
	
	vlad = F.normalize(vlad, p=2, dim=2) # intra-normalization
	
	vlad = vlad.view(N, -1) # Flatten
	
	vlad = F.normalize(vlad, p=2, dim=1) # L2 normalize
	
	return vlad
```



- [ ] 1. 
- [ ] 2.
- [ ] 3.

#### 完成内容

- [ ] 1.
- [ ] 2.



#### 问题

- [ ] 1.